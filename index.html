<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<meta name="theme-color" content="#18181b">
<meta name="description" content="AI Assistant —Å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ–º —Ç–µ–∫—Å—Ç–∞ —Å —Ñ–æ—Ç–æ">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="AI Chat">
<link rel="manifest" href="/manifest.json">
<link rel="icon" type="image/png" href="./logo_512.png">
<link rel="apple-touch-icon" href="./logo_512.png">
<title>AI Assistant</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>

<style>
/* --- –¢–ï–ú–ê –ò –¶–í–ï–¢–ê --- */
:root {
  --bg-body: #09090b;
  --bg-app: #18181b;
  --border: #27272a;
  --msg-user: #f4f4f5;
  --text-user: #09090b;
  --msg-bot: #27272a;
  --text-bot: #e4e4e7;
  --accent: #ffffff;
  --input-area: #09090b;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  height: 100vh;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  background-color: var(--bg-body);
  color: var(--text-bot);
  display: flex;
  justify-content: center;
  align-items: center;
  -webkit-tap-highlight-color: transparent;
}

.app {
  width: 100%;
  max-width: 480px;
  height: 100%;
  background: var(--bg-app);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  position: relative;
}

@media (min-width: 500px) {
  .app {
    height: 90vh;
    border-radius: 16px;
    border: 1px solid var(--border);
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
  }
}

/* --- –®–ê–ü–ö–ê --- */
header {
  padding: 16px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
  background: rgba(24, 24, 27, 0.95);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: 10;
}

.title-group {
  display: flex;
  align-items: center;
  gap: 10px;
}

.status {
  width: 8px;
  height: 8px;
  background: #22c55e;
  border-radius: 50%;
  box-shadow: 0 0 6px rgba(34, 197, 94, 0.6);
}

h1 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: #fff;
}

.btn-icon {
  background: transparent;
  border: none;
  color: #71717a;
  cursor: pointer;
  padding: 8px;
  border-radius: 8px;
  transition: 0.2s;
  -webkit-appearance: none;
  touch-action: manipulation;
}

.btn-icon:hover,
.btn-icon:active {
  background: var(--border);
  color: #fff;
}

/* --- –°–ü–ò–°–û–ö –°–û–û–ë–©–ï–ù–ò–ô --- */
#chat {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 16px;
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
}

#chat::-webkit-scrollbar { width: 5px; }
#chat::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }

.msg {
  max-width: 85%;
  padding: 12px 16px;
  border-radius: 18px;
  line-height: 1.5;
  font-size: 15px;
  word-wrap: break-word;
  white-space: pre-wrap;
  animation: slideIn 0.2s ease;
}

@keyframes slideIn {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}

.msg img {
  max-width: 100%;
  border-radius: 10px;
  margin-top: 5px;
  display: block;
}

.user {
  align-self: flex-end;
  background: var(--msg-user);
  color: var(--text-user);
  border-bottom-right-radius: 4px;
}

.bot {
  align-self: flex-start;
  background: var(--msg-bot);
  color: var(--text-bot);
  border-bottom-left-radius: 4px;
  border: 1px solid var(--border);
}

/* --- –ò–ù–î–ò–ö–ê–¢–û–† –ó–ê–ì–†–£–ó–ö–ò --- */
.typing-indicator {
  display: none;
  align-self: flex-start;
  background: var(--msg-bot);
  padding: 12px 16px;
  border-radius: 18px;
  border-bottom-left-radius: 4px;
  gap: 5px;
  align-items: center;
  border: 1px solid var(--border);
  margin-bottom: 10px;
}

.dot {
  width: 6px;
  height: 6px;
  background: #71717a;
  border-radius: 50%;
  animation: bounce 1.4s infinite ease-in-out both;
}
.dot:nth-child(1) { animation-delay: -0.32s; }
.dot:nth-child(2) { animation-delay: -0.16s; }

@keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

/* --- –û–ë–õ–ê–°–¢–¨ –í–í–û–î–ê --- */
footer {
  padding: 16px;
  background: var(--bg-app);
  border-top: 1px solid var(--border);
  display: flex;
  align-items: flex-end;
  gap: 10px;
  padding-bottom: max(16px, env(safe-area-inset-bottom));
}

.input-box {
  flex: 1;
  background: var(--input-area);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 8px 16px;
  display: flex;
  align-items: center;
  transition: 0.2s;
}

.input-box:focus-within {
  border-color: #52525b;
}

textarea {
  flex: 1;
  background: transparent;
  border: none;
  outline: none;
  color: #fff;
  font-size: 15px;
  resize: none;
  max-height: 120px;
  padding: 8px 0;
  font-family: inherit;
  line-height: 1.4;
}

.send-btn {
  background: #fff;
  color: #000;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: 0.2s;
  flex-shrink: 0;
  touch-action: manipulation;
}

.send-btn:hover { transform: scale(1.05); background: #e4e4e7; }
.send-btn:disabled { background: #3f3f46; color: #71717a; cursor: default; transform: none; }

/* PWA —É—Å—Ç–∞–Ω–æ–≤–∫–∞ */
#installPWA {
  display: none;
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #fff;
  color: #000;
  border: none;
  padding: 12px 24px;
  border-radius: 24px;
  font-weight: 600;
  cursor: pointer;
  z-index: 1000;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}
</style>
</head>
<body>

<div class="app">
  <header>
    <div class="title-group">
      <div class="status"></div>
      <h1>AI Chat</h1>
    </div>
    <button class="btn-icon" onclick="clearHistory()" title="–£–¥–∞–ª–∏—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫—É">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
    </button>
  </header>

  <div id="chat">
    <div class="msg bot">–ü—Ä–∏–≤–µ—Ç! –Ø –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å. –ü–∏—à–∏ —Ç–µ–∫—Å—Ç –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏ —Ñ–æ—Ç–æ –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è.</div>
    
    <div class="typing-indicator" id="loader">
      <div class="dot"></div>
      <div class="dot"></div>
      <div class="dot"></div>
    </div>
  </div>

  <footer>
    <input type="file" id="imageInput" accept="image/*" hidden>
    
    <button class="btn-icon" onclick="imageInput.click()" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
    </button>

    <div class="input-box">
      <textarea id="input" rows="1" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
    </div>

    <button class="send-btn" onclick="send()" id="sendBtn">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
    </button>
  </footer>
</div>

<button id="installPWA">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>

<script>
// PWA —É—Å—Ç–∞–Ω–æ–≤–∫–∞
let deferredPrompt;
const installBtn = document.getElementById('installPWA');

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display = 'block';
  
  setTimeout(() => {
    installBtn.style.display = 'none';
  }, 10000);
});

installBtn.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  
  if (outcome === 'accepted') {
    installBtn.style.display = 'none';
  }
  deferredPrompt = null;
});

window.addEventListener('appinstalled', () => {
  installBtn.style.display = 'none';
  deferredPrompt = null;
});

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => {
        console.log('ServiceWorker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
      })
      .catch(err => {
        console.log('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ServiceWorker:', err);
      });
  });
}

// –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
const chat = document.getElementById("chat");
const loader = document.getElementById("loader");
const input = document.getElementById("input");
const imageInput = document.getElementById("imageInput");
const sendBtn = document.getElementById("sendBtn");

// –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ (—Ç–µ–∫—Å—Ç)
const savedHistory = localStorage.getItem("ai_chat_v3");
let history = savedHistory ? JSON.parse(savedHistory) : [];

// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
history.forEach(m => {
  if (m.role !== 'system') {
    addMessageToUI(m.content, m.role === "user" ? "user" : "bot", false);
  }
});

// --- –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–û–ë–ê–í–õ–ï–ù–ò–Ø –°–û–û–ë–©–ï–ù–ò–ô ---
function addMessageToUI(content, type, isImage = false) {
  const div = document.createElement("div");
  div.className = "msg " + type;
  
  if (isImage) {
    const img = document.createElement("img");
    img.src = content;
    img.loading = "lazy";
    div.appendChild(img);
  } else {
    div.textContent = content;
  }
  
  chat.appendChild(div);
  chat.appendChild(loader);
  chat.scrollTop = chat.scrollHeight;
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
async function send() {
  const text = input.value.trim();
  if (!text) return;

  input.value = "";
  input.style.height = 'auto';
  
  addMessageToUI(text, "user");
  
  history.push({ role: "user", content: text });
  saveHistory();

  toggleLoader(true);

  try {
    const context = [
      { role: "system", content: "–¢—ã –ø–æ–ª–µ–∑–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ." },
      ...history.slice(-8)
    ];

    const res = await fetch("https://text.pollinations.ai/openai", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ messages: context, model: "openai" })
    });

    if (!res.ok) throw new Error("Server error");

    const data = await res.json();
    const reply = data.choices[0].message.content;

    addMessageToUI(reply, "bot");
    history.push({ role: "assistant", content: reply });
    saveHistory();

  } catch (err) {
    addMessageToUI("‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.", "bot");
    console.error(err);
  } finally {
    toggleLoader(false);
  }
}

function toggleLoader(show) {
  loader.style.display = show ? "flex" : "none";
  sendBtn.disabled = show;
  chat.scrollTop = chat.scrollHeight;
}

function saveHistory() {
  const safe = history.filter(h => h.content.length < 2000);
  localStorage.setItem("ai_chat_v3", JSON.stringify(safe));
}

// –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ (OCR)
imageInput.addEventListener("change", async () => {
  const file = imageInput.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = async function(e) {
    addMessageToUI(e.target.result, "user", true);

    toggleLoader(true);
    
    const statusMsg = document.createElement("div");
    statusMsg.className = "msg bot";
    statusMsg.textContent = "üîç –ß–∏—Ç–∞—é —Ç–µ–∫—Å—Ç —Å –∫–∞—Ä—Ç–∏–Ω–∫–∏...";
    chat.insertBefore(statusMsg, loader);

    try {
      const result = await Tesseract.recognize(file, "rus+eng");
      const text = result.data.text.trim();
      
      statusMsg.remove();

      if (text) {
        input.value = text;
        autoResize(input);
        addMessageToUI("‚úÖ –¢–µ–∫—Å—Ç –Ω–∞–π–¥–µ–Ω! –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π –µ–≥–æ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞.", "bot");
      } else {
        addMessageToUI("‚ùå –¢–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.", "bot");
      }
    } catch (e) {
      statusMsg.remove();
      addMessageToUI("‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ.", "bot");
    } finally {
      toggleLoader(false);
      imageInput.value = "";
    }
  };
  reader.readAsDataURL(file);
});

// –ê–≤—Ç–æ-–≤—ã—Å–æ—Ç–∞ –ø–æ–ª—è –≤–≤–æ–¥–∞
function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = el.scrollHeight + 'px';
}
input.addEventListener('input', () => autoResize(input));

// Enter = –û—Ç–ø—Ä–∞–≤–∏—Ç—å, Shift+Enter = –ù–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞
input.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    send();
  }
});

function clearHistory() {
  if (confirm("–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç?")) {
    localStorage.removeItem("ai_chat_v3");
    history = [];
    chat.innerHTML = "";
    chat.appendChild(loader);
    addMessageToUI("–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞.", "bot");
  }
}

// –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
window.addEventListener('beforeunload', (e) => {
  if (input.value.trim()) {
    e.preventDefault();
    e.returnValue = '';
  }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ online/offline —Å—Ç–∞—Ç—É—Å–∞
window.addEventListener('online', () => {
  addMessageToUI("‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ", "bot");
});

window.addEventListener('offline', () => {
  addMessageToUI("‚ö†Ô∏è –í—ã offline, –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã", "bot");
});
</script>
</body>
</html>
